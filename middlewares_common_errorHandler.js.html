<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8" />
    <title>middlewares/common/errorHandler.js - jimpex docs</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css" />
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
    <link rel="shortcut icon" href="icons/favicon-48.png" />
    <link rel="apple-touch-icon" sizes="48x48" href="icons/favicon-48.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="icons/favicon-72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="icons/favicon-96.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="icons/favicon-144.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/favicon-192.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="icons/favicon-256.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="icons/favicon-384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/favicon-512.png" />
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html" class="home-link">jimpex</a></h2><ul class="ref-links">
            <li><a
                class="ref-link -yarn"
                title="View the package on Yarn"
                href="https://yarnpkg.com/package/jimpex"
                target="_blank"
            >View the package on Yarn</a></li>
        

            <li><a
                class="ref-link -github"
                title="Go to the GitHub repository"
                href="https://github.com/homer0/jimpex"
                target="_blank"
            >Go to the GitHub repository</a></li>
        

            <li><a
                class="ref-link -npm"
                title="View the package on NPM"
                href="https://www.npmjs.com/package/jimpex"
                target="_blank"
            >View the package on NPM</a></li>
        </ul><h3>Modules</h3><ul><li><a href="module-constants.html">constants</a></li><li><a href="module-controllers.html">controllers</a></li><li><a href="module-core.html">core</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core.html#~jimpex">jimpex</a></li></ul></li><li><a href="module-functions.html">functions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-functions.html#.createRouteExpression">createRouteExpression</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.escapeForRegExp">escapeForRegExp</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.removeLeadingSlash">removeLeadingSlash</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.removeSlashes">removeSlashes</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.removeTrailingSlash">removeTrailingSlash</a></li></ul></li><li><a href="module-middlewares.html">middlewares</a></li><li><a href="module-services.html">services</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-services.html#.appErrorGenerator">appErrorGenerator</a></li><li data-type='method' style='display: none;'><a href="module-services.html#.httpErrorGenerator">httpErrorGenerator</a></li><li data-type='method' style='display: none;'><a href="module-services.html#.sendFile">sendFile</a></li></ul></li><li><a href="module-wrappers.html">wrappers</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-wrappers.html#.controller">controller</a></li><li data-type='method' style='display: none;'><a href="module-wrappers.html#.controllerCreator">controllerCreator</a></li><li data-type='method' style='display: none;'><a href="module-wrappers.html#.middleware">middleware</a></li><li data-type='method' style='display: none;'><a href="module-wrappers.html#.middlewareCreator">middlewareCreator</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-controllers.html">controllers</a></li><li><a href="tutorial-middlewares.html">middlewares</a></li><li><a href="tutorial-options.html">options</a></li><li><a href="tutorial-services.html">services</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">middlewares/common/errorHandler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const ObjectUtils = require('wootils/shared/objectUtils');
const { code: statuses } = require('statuses');
const { middlewareCreator } = require('../../utils/wrappers');

/**
 * @typedef {import('../../types').ExpressMiddleware} ExpressMiddleware
 * @typedef {import('../../types').Logger} Logger
 * @typedef {import('../../services/http/responsesBuilder').ResponsesBuilder} ResponsesBuilder
 * @prettierignore
 */

/**
 * @typedef {import('../../types').MiddlewareCreator&lt;O>} MiddlewareCreator&lt;O>
 * @template O
 */

/**
 * Before reading the recevied information, these will be the settings for the response.
 *
 * @typedef {Object} ErrorHandlerDefaultOptions
 * @property {string} message  The error message the response will show. Default `'Oops!
 *                             Something went wrong, please try again'`.
 * @property {number} status   The HTTP status code for the response. Default `500`.
 * @parent module:middlewares
 */

/**
 * The options for how to build the middleware responses.
 *
 * @typedef {Object} ErrorHandlerOptions
 * @property {ErrorHandlerDefaultOptions} default  The options to build the default
 *                                                 response,
 *                                                 before the middleware analyzes the
 *                                                 recevied error.
 * @parent module:middlewares
 */

/**
 * Provides the middleware to handle error responses for the app.
 *
 * @parent module:middlewares
 */
class ErrorHandler {
  /**
   * @param {Logger}              appLogger         To log the received errors.
   * @param {ResponsesBuilder}    responsesBuilder  To generate the JSON response.
   * @param {boolean}             showErrors        If `false`, unknown errors will show a
   *                                                generic message instead of real
   *                                                message. And if `true`,
   *                                                it will not only show all kind of
   *                                                errors but it will also show the error
   *                                                stack.
   * @param {ClassAppError}       AppError          To validate if the received errors are
   *                                                known or not.
   * @param {ErrorHandlerOptions} [options={}]      Custom options to modify the
   *                                                middleware behavior.
   */
  constructor(appLogger, responsesBuilder, showErrors, AppError, options = {}) {
    /**
     * A local reference for the `appLogger` service.
     *
     * @type {Logger}
     * @access protected
     * @ignore
     */
    this._appLogger = appLogger;
    /**
     * A local reference for the `responsesBuilder` service.
     *
     * @type {ResponsesBuilder}
     * @access protected
     * @ignore
     */
    this._responsesBuilder = responsesBuilder;
    /**
     * Whether or not to show unknown errors real messages.
     *
     * @type {boolean}
     * @access protected
     * @ignore
     */
    this._showErrors = showErrors;
    /**
     * A local reference for the class the app uses to generate errors.
     *
     * @type {ClassAppError}
     * @access protected
     * @ignore
     */
    this._AppError = AppError;
    /**
     * These are the "settings" the middleware will use in order to display the errors.
     *
     * @type {ErrorHandlerOptions}
     * @access protected
     * @ignore
     */
    this._options = ObjectUtils.merge(
      {
        default: {
          message: 'Oops! Something went wrong, please try again',
          status: statuses['internal server error'],
        },
      },
      options,
    );
  }
  /**
   * Returns the Express middleware that shows the errors.
   *
   * @returns {ExpressMiddleware}
   */
  middleware() {
    return (err, req, res, next) => {
      // If the middleware received an error...
      if (err) {
        // Define the error response basic template.
        let data = {
          error: true,
          message: this._options.default.message,
        };
        // Define the error response default status.
        let { status } = this._options.default;
        // Validate if the error is known or not.
        const knownError = err instanceof this._AppError;
        // If the `showErrors` flag is enabled or the error is a known error...
        if (this._showErrors || knownError) {
          // ...set the error real message on the response.
          data.message = err.message;
          // If the error type is known...
          if (knownError) {
            // Try to get any extra information that should be included on the response.
            data = Object.assign(data, err.response);
            // Try to obtain the response status from the error
            status = err.status || statuses['bad request'];
          }
          // If the `showErrors` flag is enabled...
          if (this._showErrors) {
            // Get the error stack and format it into an `Array`.
            const stack = err.stack.split('\n').map((line) => line.trim());
            //  Add the stack to the response.
            data.stack = stack;
            // Remove the first item of the stack, since it's the same as the message.
            stack.splice(0, 1);
            // Log the error.
            this._appLogger.error(`ERROR: ${err.message}`);
            this._appLogger.info(stack);
          }
        }
        // Send the response.
        this._responsesBuilder.json(res, data, status);
      } else {
        // ...otherwise, move to the next middleware.
        next();
      }
    };
  }
  /**
   * The options used to customize the middleware behavior.
   *
   * @returns {ErrorHandlerOptions}
   */
  get options() {
    return this._options;
  }
}
/**
 * Generates a middleware that show responses for unhandled errors thrown by the app.
 *
 * @type {MiddlewareCreator&lt;ErrorHandlerOptions>}
 * @parent module:middlewares
 */
const errorHandler = middlewareCreator((options) => (app) => {
  const showErrors = app.get('appConfiguration').get('debug.showErrors') === true;
  return new ErrorHandler(
    app.get('appLogger'),
    app.get('responsesBuilder'),
    showErrors,
    app.get('AppError'),
    options,
  ).middleware();
});

module.exports.ErrorHandler = ErrorHandler;
module.exports.errorHandler = errorHandler;
</code></pre>
        </article>
    </section>





    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using a forked <a href="https://github.com/homer0/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
