<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8" />
    <title>middlewares - jimpex docs</title>
    
    
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify.css" />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css" />
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
    <link rel="shortcut icon" href="icons/favicon-48.png" />
    <link rel="apple-touch-icon" sizes="48x48" href="icons/favicon-48.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="icons/favicon-72.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="icons/favicon-96.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="icons/favicon-144.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/favicon-192.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="icons/favicon-256.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="icons/favicon-384.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/favicon-512.png" />
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html" class="home-link">jimpex</a></h2><ul class="ref-links">
            <li><a
                class="ref-link -yarn"
                title="View the package on Yarn"
                href="https://yarnpkg.com/package/jimpex"
                target="_blank"
            >View the package on Yarn</a></li>
        

            <li><a
                class="ref-link -github"
                title="Go to the GitHub repository"
                href="https://github.com/homer0/jimpex"
                target="_blank"
            >Go to the GitHub repository</a></li>
        

            <li><a
                class="ref-link -npm"
                title="View the package on NPM"
                href="https://www.npmjs.com/package/jimpex"
                target="_blank"
            >View the package on NPM</a></li>
        </ul><h3>Modules</h3><ul><li><a href="module-constants.html">constants</a></li><li><a href="module-controllers.html">controllers</a></li><li><a href="module-core.html">core</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-core.html#~jimpex">jimpex</a></li></ul></li><li><a href="module-functions.html">functions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-functions.html#.createRouteExpression">createRouteExpression</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.escapeForRegExp">escapeForRegExp</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.removeLeadingSlash">removeLeadingSlash</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.removeSlashes">removeSlashes</a></li><li data-type='method' style='display: none;'><a href="module-functions.html#.removeTrailingSlash">removeTrailingSlash</a></li></ul></li><li><a href="module-middlewares.html">middlewares</a></li><li><a href="module-services.html">services</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-services.html#.appErrorGenerator">appErrorGenerator</a></li><li data-type='method' style='display: none;'><a href="module-services.html#.httpErrorGenerator">httpErrorGenerator</a></li><li data-type='method' style='display: none;'><a href="module-services.html#.sendFile">sendFile</a></li></ul></li><li><a href="module-wrappers.html">wrappers</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-wrappers.html#.controller">controller</a></li><li data-type='method' style='display: none;'><a href="module-wrappers.html#.controllerCreator">controllerCreator</a></li><li data-type='method' style='display: none;'><a href="module-wrappers.html#.middleware">middleware</a></li><li data-type='method' style='display: none;'><a href="module-wrappers.html#.middlewareCreator">middlewareCreator</a></li></ul></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-controllers.html">controllers</a></li><li><a href="tutorial-middlewares.html">middlewares</a></li><li><a href="tutorial-options.html">options</a></li><li><a href="tutorial-services.html">services</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">middlewares</h1>
    

    <section>
  <header>
    <h2>middlewares</h2>
  </header>
  <article class="tutorial">
    <h1>Built-in Middlewares</h1>
<p>All of these controllers are available on the Jimpex package and can be easily required and implemented.</p>
<h2>Error Handler</h2>
<p>Allows you to generate responses for errors and potentially hide uncaught exceptions under a generic message, unless it's disabled via configuration settings.</p>
<ul>
<li>Module: <code>common</code></li>
<li>Requires: <code>responsesBuilder</code> and <code>appError</code></li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  services: {
    http: { responsesBuilder },
    common: { appError },
  },
  middlewares: {
    common: { errorHandler },
  },
};

class App extends Jimpex {
  boot() {
    // Register the dependencies...
    this.register(responsesBuilder);
    this.register(appError);
    
    ...
    
    // Add the middleware at the end.
    this.use(errorHandler);
  }
}
</code></pre>
<p>Now, there's a configuration setting for this controller: <code>debug.showErrors</code>. By enabling the setting, the middleware will show the message and the stack information of all kind of errors.</p>
<p>If the configuration setting is disabled (or not present), the errors stack will never be visible, and if the error is not an instance of <code>AppError</code>, it will show a generic message.</p>
<p>By default, the generic message is <em>&quot;Oops! Something went wrong, please try again&quot;</em> and the default HTTP status is <code>500</code>, but you can use it as a function to modify those defaults:</p>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  services: {
    http: { responsesBuilder },
    common: { appError },
  },
  middlewares: {
    common: { errorHandler },
  },
};

class App extends Jimpex {
  boot() {
    // Register the dependencies...
    this.register(responsesBuilder);
    this.register(appError);
    
    ...
    
    // Add the middleware at the end.
    this.use(errorHandler({
      default: {
        message: 'Unknown error',
        status: 503,
      },
    }));
  }
}
</code></pre>
<p>Finally, when using errors of the type <code>AppError</code>, you can add the following context information:</p>
<pre class="prettyprint source lang-js"><code>// Assuming `AppError` is the injected `AppError` and you are on the context of a middleware
next(new AppError('Something went wrong', {
  status: someHTTPStatus,
  response: someObject,
}));
</code></pre>
<ul>
<li><code>status</code> will replace the error responses HTTP status.</li>
<li><code>response</code> will be merged into the error response <code>data</code> key.</li>
</ul>
<h2>Force HTTPS</h2>
<p>Redirect all incoming traffic from HTTP to HTTPS. It also allows you to set routes to ignore the redirection.</p>
<ul>
<li>Module: <code>common</code></li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  middlewares: {
    common: { forceHTTPS },
  },
};

class App extends Jimpex {
  boot() {
    // Add the middleware first.
    this.use(forceHTTPS);
  }
}
</code></pre>
<p>By default, it redirects all the URLs that don't start with <code>/service/</code> from HTTP to HTTPs, but you can use it as a function to modify the rules:</p>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  middlewares: {
    common: { forceHTTPS },
  },
};

class App extends Jimpex {
  boot() {
    // Add the middleware first.
    this.use(forceHTTPS([
      /^\/service\//,
      /^\/api\//,
    ]));
  }
}
</code></pre>
<p><strong>VERY IMPORTANT:</strong> The forced redirection will only happen if your configuration has a setting named <code>forceHTTPS</code> with a value of <code>true</code>.</p>
<h2>HSTS</h2>
<p>It configures a <code>Strict-Transport-Security</code> header and includes it on every response.</p>
<ul>
<li>Module: <code>common</code></li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  middlewares: {
    common: { hsts },
  },
};

class App extends Jimpex {
  boot() {
    // Add the middleware first.
    this.use(hsts);
  }
}
</code></pre>
<p>You can also use it as a function and send the following options:</p>
<ul>
<li><code>maxAge</code>: The time, in seconds, that the browser should remember that a site is only to be accessed using HTTPS. The default value is <code>31536000</code> (one year).</li>
<li><code>includeSubDomains</code>: Whether or not the rule should apply to all sub domains. The default value is <code>true</code>.</li>
<li><code>preload</code>: Whether or not to include on the major browsers' preload list. This directive is not part of the specification, for more information about it, you should check the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security">MDN documentation</a> for the header. The default value is <code>false</code>.</li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  middlewares: {
    common: { hsts },
  },
};

class App extends Jimpex {
  boot() {
    // Add the middleware first.
    this.use(hsts({
      maxAge: 5,
      includeSubDomains: false,
    }));
  }
}
</code></pre>
<blockquote>
<p>You can also send an <code>enabled</code> option, set to <code>false</code>, in case you want to disable the middleware.</p>
</blockquote>
<p>If you don't send options, before using the defaults, it will first try to obtain them for a <code>hsts</code> key on the <code>appConfiguration</code> service, so you can also manage how the feature works from your project configuration.</p>
<h2>Fast HTML</h2>
<p>Allows your app to skip unnecessary processing by showing an specific HTML when a requested route doesn't have a controller for it or is not on a &quot;whitelist&quot;</p>
<ul>
<li>Module: <code>html</code></li>
<li>Requires: <code>events</code>, <code>sendFile</code> and, optionally, an <code>HTMLGenerator</code> service.</li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  services: {
    common: { sendFile },
  },
  middlewares: {
    html: { fastHTML },
  },
};

class App extends Jimpex {
  boot() {
    // Register the dependencies...
    this.register(sendFile);
    
    // Add the middleware on one of the first positions.
    this.use(fastHTML);
  }
}
</code></pre>
<p>The middleware has a few options with default values that can be customized:</p>
<pre class="prettyprint source lang-js"><code>{
  // The name of the file it will serve.
  file: 'index.html',
  // A list of expressions for routes that should be ignored.
  ignore: [/\.ico$/i],
  // Whether or not to use the routes controlled by the app to validate the requests.
  useAppRoutes: true,
  // The name of the HTML Generator service the middleware can use to obtain the HTML. 
  htmlGenerator: 'htmlGenerator',
}
</code></pre>
<p>You can customize all those options by just calling the middleware as a function:</p>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  services: {
    common: { sendFile },
  },
  middlewares: {
    html: { fastHTML },
  },
};

class App extends Jimpex {
  boot() {
    // Register the dependencies...
    this.register(sendFile);
    
    // Add the middleware on one of the first positions.
    this.use(fastHTML({
      file: 'my-custom-index.html',
      ignore: [`/^\/service\//`],
      useAppRoutes: false,
      htmlGenerator: null, // To disable it.
    }));
  }
}
</code></pre>
<p>Now, as mentioned on the requirements, you can optionally use the <code>htmlGenerator</code> service or an <code>HTMLGenerator</code>-like service to serve a generated file.</p>
<p>You use the <code>htmlGenerator</code> option to disable it, or modify the name of the service it will look for:</p>
<ul>
<li>If you set it to a <em>&quot;falsy&quot;</em> value, it will be disabled.</li>
<li>If you change its name, it will try to look for that service when mounted.</li>
</ul>
<p><strong>Important:</strong> When using the generator, no matter the value you set on the <code>file</code> option, it will overwritten with the name of the file from the generator service.</p>
<h2>Show HTML</h2>
<p>A really simple middleware to serve an HTML file. Its true feature is that it can be hooked up to the <strong>HTML Generator</strong> service.</p>
<ul>
<li>Module: <code>html</code></li>
<li>Requires: <code>sendFile</code> and, optionally, an <code>HTMLGenerator</code> service.</li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  services: {
    common: { sendFile },
  },
  middlewares: {
    html: { showHTML },
  },
};

class App extends Jimpex {
  boot() {
    // Register the dependencies...
    this.register(sendFile);
    
    // Add the middleware at the end.
    this.use(showHTML);
  }
}
</code></pre>
<p>By default, if the middleware is reached, it will show an <code>index.html</code>, but you can use it as a function to modify the filename:</p>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  services: {
    common: { sendFile },
  },
  middlewares: {
    html: { showHTML },
  },
};

class App extends Jimpex {
  boot() {
    // Register the dependencies...
    this.register(sendFile);
    
    // Add the middleware at the end.
    this.use(showHTML({
      file: 'my-file.html',
    }));
  }
}
</code></pre>
<p>Now, as mentioned on the requirements, you can optionally use the <code>htmlGenerator</code> or an <code>HTMLGenerator</code> service to show the generated file.</p>
<p>The default implementation checks if there's an <code>htmlGenerator</code> service registered on the app and uses that file; and in the case of <code>showHTML</code>, you can specify a second parameter with the name of the <code>HTMLGenerator</code> service name you want to use.</p>
<h2>Version validator</h2>
<p>This can be used as a middleware and as controller. The idea is that it validates a <code>version</code> parameter against the version defined on the configuration.</p>
<ul>
<li>Module: <code>utils</code></li>
<li>Requires: <code>appConfiguration</code>, <code>responsesBuilder</code> and <code>appError</code></li>
</ul>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  middlewares: {
    utils: { versionValidator },
  },
};

class App extends Jimpex {
  boot() {
    // Add the middleware before the routes you want to be protected.
    this.use(versionValidator);
    // or, protect a specific route.
    this.mount('/to-protect', versionValidator);
  }
}
</code></pre>
<p>By default, it comes with a lot of already defined options, like whether or not to allow <code>latest</code> as a version, but you can use it as a function to modify them, for example:</p>
<pre class="prettyprint source lang-js"><code>const {
  Jimpex,
  middlewares: {
    utils: { versionValidator },
  },
};

class App extends Jimpex {
  boot() {
    // Add the middleware before the routes you want to be protected.
    this.use(versionValidator({
      latest: {
        allow: false,
      }
    }));
    // or, protect a specific route.
    this.mount('/to-protect', versionValidator({
      latest: {
        allow: false,
      }
    }));
  }
}
</code></pre>
<p><strong>Very important:</strong> The middleware will only validate if <code>req.params.version</code> is found.</p>
  </article>
  
</section>


    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using a forked <a href="https://github.com/homer0/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>